<template>
  <el-button type="primary" @click="addCourse">新建课程</el-button>
  <div>
    <el-table :data="item.values" style="width: 100%">
      <!-- <el-table-column fixed prop="id" label="Id" width="300" /> -->
      <el-table-column prop="name" label="课程名" width="300" />
      <el-table-column prop="comment" label="课程详情" width="400" />
      <el-table-column prop="createTime" label="创建时间" width="300" />
      <el-table-column prop="username" label="任课老师" width="100" />
      <el-table-column fixed="right" label="操作" min-width="120">
        <template #default="scope">
          <el-button type="primary" size="small" @click.prevent="modifyRow(scope.$index)">
            修改
          </el-button>
          <el-button  type="danger" size="small" @click.prevent="deleteRow(scope.$index)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
  <div v-if="formChange">
    <el-dialog v-model="dialogFormVisible" title="课程信息修改" width="500">
      <el-form :model="form">
        <el-form-item label="id">
          <el-input v-model="form.id" autocomplete="off" disabled />
        </el-form-item>
        <el-form-item label="name">
          <el-input v-model="form.name" autocomplete="off" />
        </el-form-item>
        <el-form-item label="comment">
          <el-input v-model="form.comment" autocomplete="off" />
        </el-form-item>
        <el-form-item label="tid">
          <el-input v-model="form.tid" autocomplete="off" />
        </el-form-item>
        <el-form-item label="username">
          <el-input v-model="form.username" autocomplete="off" disabled />
        </el-form-item>
        <el-form-item label="createTime">
          <el-input v-model="form.createTime" autocomplete="off" disabled />
        </el-form-item>
      </el-form>
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="dialogFormVisible = false">取消</el-button>
          <el-button type="primary" @click.prevent="handleModify">
            确认
          </el-button>
        </div>
      </template>
    </el-dialog>
  </div>
  <div v-else>
    <el-dialog v-model="dialogFormVisible" title="新建课程" width="500">
      <el-form :model="form">
        <el-form-item label="课程名称">
          <el-input v-model="form.name" autocomplete="off" />
        </el-form-item>
        <el-form-item label="课程描述">
          <el-input v-model="form.comment" autocomplete="off" />
        </el-form-item>
        <!-- <el-form-item label="教师id">
          <el-input v-model="form.tid" autocomplete="off" />
        </el-form-item> -->
      </el-form>
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="dialogFormVisible = false">取消</el-button>
          <el-button type="primary" @click.prevent="createNewCourse">
            确认
          </el-button>
        </div>
      </template>
    </el-dialog>
  </div>
  <div class="footer-box">
      <Pagination background layout="prev, pager, next, jumper" :total="total" :pageSize="pageSize"
        :current-page.sync="currentPage" @update:currentPage="handlePageChange" @update:pageSize="handleSizeChange" />
    </div>
</template>

<script setup>
import Pagination from '@/components/pagination.vue';
import { ref, reactive, onMounted, toRaw } from "vue";
import { ElMessage, ElMessageBox } from "element-plus";
import {
  createCourse,
  updateCourse,
  deleteCourseById,
  getAllCourse
} from "@/api/examCourse";
import { createExamTeacherCourse } from "@/api/examTeacherCourse";
import { useStore } from "vuex";
const store = useStore();
const item = reactive({ values: [] });

//清空临时表单
function refreshForm() {
  form.id = "";
  form.name = "";
  form.comment = "";
  form.createTime = "";
  form.username = "";
  form.tid = "";
  console.log(form.id + "执行刷新表单");
}

//修改临时表单
let form = reactive({
  id: "",
  name: "",
  comment: "",
  createTime: "",
  username: "",
  tid: "",
});

//删除记录
const deleteRow = (index) => {
  // console.log(index);
  ElMessageBox.confirm("确认删除该课程信息？", "警告", {
    confirmButtonText: "确认",
    cancelButtonText: "取消",
    type: "warning",
  })
    .then(() => {
      deleteCourseById(item.values[index].id)
        .then((res) => {
          if ((res.status = "201")) {
            refreshCourseInfo();
            ElMessage({
              type: "success",
              message: "删除成功",
            });
          }
        })
        .catch((err) => {
          console.log(err);
        });
    })
    .catch(() => {
      ElMessage({
        type: "info",
        message: "取消删除",
      });
    });
};

const dialogFormVisible = ref(false); //弹出表单的显示隐藏控制
const formLabelWidth = '140px' // 弹出表单大小
const formChange = ref(true); // 改变弹出表单框

//修改记录
const modifyRow = (index) => {
  console.log("修改记录:", index);
  formChange.value = true;
  dialogFormVisible.value = true; // 修改框显示
  form.id = item.values[index].id;
  form.name = item.values[index].name;
  form.comment = item.values[index].comment;
  form.tid = item.values[index].tid;
  form.username = item.values[index].username;
  form.createTime = item.values[index].createTime;
};

//处理修改
function handleModify() {
  console.log();
  updateCourse(toRaw(form))
    .then((res) => {
      console.log(res + "执行更新里的获取用户操作");
      refreshForm();
      refreshCourseInfo();
      ElMessageBox.alert("修改成功", "提示", {
        confirmButtonText: "确认",
        callback: (action) => {
          dialogFormVisible.value = false;
        },
      });
    })
    .catch((err) => {
      console.log(err);
    });
}

// 添加课程
function addCourse() {
  refreshForm();
  formChange.value = false;
  dialogFormVisible.value = true;
}

// 创建课程
function createNewCourse() {
  const tempForm = toRaw(form);
   createCourse(tempForm.name, tempForm.comment).then((res) => {
    console.log(store.state.user.userInfo.id," ", res.data);
    createExamTeacherCourse({ teacherId: tempForm.tid, courseId: res.data }).then(res => {
      console.log("课程老师中间表新建记录", res);
      refreshCourseInfo();
    })
    // refreshCourseInfo();
    ElMessageBox.alert("添加成功", "新建课程", {
      confirmButtonText: "OK",
      callback: (action) => {
        dialogFormVisible.value = false;
      },
    });
  });
}
const total = ref(0);
const pageSize = ref(10);
const currentPage = ref(1);
let allClasses = [];

//刷新课程信息
function refreshCourseInfo() {
  getAllCourse()
    .then((res) => {
      console.log("刷新课程信息成功");
      allClasses = res.data || [];
      total.value = allClasses.length;
      updateTableData();
    })
    .catch((err) => { });
}

const updateTableData = () => {
  item.values = allClasses.slice((currentPage.value - 1) * pageSize.value, currentPage.value * pageSize.value);
};

const handlePageChange = (page) => {
  console.log("Page changed to:", page);
  currentPage.value = page;
  updateTableData();
};

const handleSizeChange = (size) => {
  console.log("Page size changed to:", size);
  pageSize.value = size;
  updateTableData();
};

onMounted(() => {
  refreshCourseInfo();
});

</script>

<style lang='less'>
.el-button--primary {
  margin: 10px;
}

.el-table td.el-table__cell,
.el-table th.el-table__cell.is-leaf {
  text-align: center;
}

.footer-box{
  width: 90%; 
  display: flex; 
  justify-content: center;
  margin-top: 10px;
  padding: 10px;
}
</style>